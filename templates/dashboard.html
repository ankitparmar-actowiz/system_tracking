<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard</title>
  <link rel="stylesheet" href="/static/style.css" />
  <script src="https://unpkg.com/htmx.org@1.9.6"></script>
</head>

<body>
<div class="container">

  <!-- Header -->
  <header>
    <h1>ğŸ–¥ï¸ System Tracking Dashboard</h1>
    <div class="user-panel">
      <span>ğŸ‘‹ Welcome, <strong>{{ user.name }}</strong></span>
      <a href="/logout">Logout</a>
    </div>
  </header>

  {% if request.query_params.get("error") %}
    <div class="alert">âš ï¸ {{ request.query_params.get("error") }}</div>
  {% endif %}

  <!-- USER BOOK SYSTEM -->
  {% if user.role == "user" %}
  <section class="card">
    <h2>ğŸŸ¢ Book a System</h2>
    <form hx-post="/book" hx-swap="none">
      <select name="ip" required>
        <option value="">Select IP</option>
        {% for s in systems %}
          <option value="{{ s.ip }}">{{ s.ip }}</option>
        {% endfor %}
      </select>

      <input type="text" name="project" placeholder="ğŸ“Œ Project Name" required />
      <input type="number" step="0.5" name="duration" placeholder="â±ï¸ Duration (hrs)" required />

      <button type="submit">ğŸ“¥ Book System</button>
    </form>
  </section>
  {% endif %}

  <!-- MANAGER + ASSIGNER SYSTEM ASSIGN -->
  {% if user.role in ['manager', 'assigner'] %}
  <section class="card">
    <h2>ğŸ‘” Assign System</h2>
    <form hx-post="/assign" hx-swap="none">
      <select name="system" required>
        <option value="">Choose System</option>
        {% for s in all_systems %}
          {% if s.status == "free" %}
            <option value="{{ s.ip }} - free">{{ s.ip }} - Free</option>
          {% else %}
            <option value="{{ s.ip }} - using (Owner: {{ s.owner }})">
              {{ s.ip }} - Used by {{ s.owner }}
            </option>
          {% endif %}
        {% endfor %}
      </select>

      <select name="user_name" required>
        <option value="">Assign To</option>
        {% for u in normal_users %}
          <option value="{{ u }}">{{ u }}</option>
        {% endfor %}
      </select>

      <input type="text" name="project" placeholder="ğŸ“Œ Project Name" required />
      <input type="number" step="0.5" name="duration" placeholder="â±ï¸ Duration (hrs)" required />
      <button type="submit">âœ… Assign Now</button>
    </form>
  </section>
  {% endif %}

  <!-- PROMOTE USER -->
  {% if user.role == "manager" %}
  <section class="card">
    <h2>ğŸ‘‘ Promote User</h2>
    <form hx-post="/promote" hx-swap="none">
      <select name="email" required>
        <option value="">Select Email</option>
        {% for u in all_users %}
          <option value="{{ u.email }}">{{ u.email }} ({{ u.name }})</option>
        {% endfor %}
      </select>
      <button name="role" value="manager" type="submit">â­ To Manager</button>
      <button name="role" value="assigner" type="submit">ğŸ”§ To Assigner</button>
    </form>
  </section>
  {% endif %}

  <!-- MANAGE IPs -->
  {% if user.role in ['manager', 'assigner'] %}
  <section class="card">
    <h2>â•â– Manage IPs</h2>

    <form hx-post="/add/system" hx-swap="none">
      <input type="text" name="ip" placeholder="New IP Address" required />
      <button type="submit">â• Add IP</button>
    </form>

    {% set ns = namespace(ips=[]) %}
    {% for s in systems %}{% set _ = ns.ips.append(s.ip) %}{% endfor %}
    {% for a in active %}{% set _ = ns.ips.append(a.ip) %}{% endfor %}

    <form hx-post="/remove/system" hx-swap="none" style="margin-top:10px;">
      <select name="ip" required>
        <option value="">Remove IP</option>
        {% for ip in ns.ips | sort | unique %}
          <option value="{{ ip }}">{{ ip }}</option>
        {% endfor %}
      </select>
      <button type="submit">âŒ Remove IP</button>
    </form>
  </section>
  {% endif %}

  <!-- ====================== -->
  <!-- ACTIVE SYSTEMS SECTION -->
  <!-- ====================== -->
  <section class="card">
    <h2>ğŸ”´ Currently In Use</h2>

    {% if active %}
      {% for a in active %}
      <div class="system-box" style="margin-bottom:20px; padding:12px; border:1px solid #eee; border-radius:8px; background:#000;">

        <div style="font-size:1.1em; margin-bottom:6px;"><strong>{{ a.ip }}</strong>

        {% if a.get('main_released') %}
        <span style="font-style: italic; color:#8d960d;">
            - Main system is released by {{ a.user }}, contrib remains
        </span>
        {% endif %}

        </div>

        <div style="margin-left: 10px;">
          <div>ğŸ‘¤ <strong>Main User:</strong> {{ a.user }}</div>
          <div>ğŸ“Œ <strong>Project:</strong> {{ a.project }}</div>
          <div>â±ï¸ <strong>Duration:</strong> {{ a.duration }} hrs</div>
          <div>ğŸ•— <strong>Started:</strong> {{ a.start_time.strftime('%Y-%m-%d %H:%M') }}</div>
        </div>

        
        <!-- CONTRIBUTORS LIST (UPDATED) -->
        {% if a.contributors %}
        <div style="margin-top:12px; padding:10px; background:#111; border-radius:6px;">
          <strong style="color:#1e88e5;">ğŸ‘¥ Contributors:</strong>

          {% for c in a.contributors %}
          <div style="margin-left:16px; padding:3px 0;">

            ğŸ‘¤ {{ c.contributor }}  
            | ğŸ“Œ {{ c.project }}  
            | â±ï¸ {{ c.duration }} hrs  

          </div>
          {% endfor %}
        </div>
        {% endif %}
        
        <!-- RELEASE BUTTONS -->
        <div style="margin-top:10px;">

          <!-- MAIN USER RELEASE -->
          {% if a.user == user.name and not a.get('main_released') %}
          <form hx-post="/release/main" hx-swap="none">
            <input type="hidden" name="ip" value="{{ a.ip }}" />
            <button type="submit" style="background:#17a2b8; color:white; padding:6px 12px; border:none; border-radius:4px;">
              ğŸŸ¦ Release Main System: {{ a.ip }} of Project: {{ a.project }}
            </button>
          </form>
          {% endif %}

          <!-- CONTRIBUTOR LEAVE BUTTON -->
          {% for c in a.contributors %}
          {% if c.contributor == user.name %}
          <form hx-post="/release/contrib" hx-swap="none">
            <input type="hidden" name="main_ip" value="{{ c.main_ip }}">
            <input type="hidden" name="contributor" value="{{ c.contributor }}">
            <button style="background:#6c757d; color:white; padding:6px 12px; border:none; border-radius:4px;">
              ğŸ”µ Leave Contib System: {{ c.main_ip }} of Project: {{ c.project }}
            </button>
          </form>
          {% endif %}
          {% endfor %}

          <!-- NORMAL USER CONTRIBUTION -->
          {% if user.role == "user" and a.user != user.name %}
          <form hx-post="/self/contribute" hx-swap="none" style="margin-top:10px;">
            <input type="hidden" name="system" value="{{ a.ip }} - using (Owner: {{ a.user }})">

            <input type="text" name="project" placeholder="ğŸ“Œ Project Name" required style="margin-bottom:6px;">
            <input type="number" step="0.5" name="duration" placeholder="â±ï¸ Hours" required style="margin-bottom:6px;">

            <button type="submit" style="background:#007bff; color:#fff; padding:6px 12px; border:none; border-radius:4px;">
              â• Join as Contributor
            </button>
          </form>
          {% endif %}

        </div>

        
      </div>
      {% endfor %}
      
      {% else %}
      <p>ğŸŸ¢ No systems in use.</p>
      {% endif %}
    </section>

  <!-- LOGS -->
  <section class="card">
    <h2>ğŸ“œ Today's Logs</h2>
    {% if logs %}
      <table class="log-table">
        <tr><th>IP</th><th>User</th><th>Project</th><th>Time</th><th>Type</th></tr>
        {% for log in logs %}
        <tr>
          <td>{{ log.ip }}</td>
          <td>{{ log.user }}</td>
          <td>{{ log.project }}</td>
          <td>{{ log.start_time.strftime('%H:%M') }} â¡ï¸ {{ log.end_time.strftime('%H:%M') if log.end_time else 'â€”' }}</td>
          <td>{% if log.is_contribution %}<i>Contribution</i>{% else %}Main{% endif %}</td>
        </tr>
        {% endfor %}
      </table>
    {% else %}
      <p>â„¹ï¸ No logs today.</p>
    {% endif %}
  </section>

</div>

<!-- TOAST -->
<div id="notification-toast"
  style="position:fixed; top:10px; right:10px; z-index:9999; padding:12px 20px; color:white;
         border-radius:8px; background:#28a745; opacity:0; transition:opacity .3s; pointer-events:none;">
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  let toastTimeout;

  document.body.addEventListener('showNotification', function(evt) {
    const toast = document.getElementById('notification-toast');
    const detail = evt.detail;

    if (toastTimeout) clearTimeout(toastTimeout);

    toast.textContent = (detail.type === 'success' ? 'âœ… ' : 'âŒ ') + detail.message;
    toast.style.backgroundColor = detail.type === 'error' ? '#dc3545' : '#28a745';

    toast.style.opacity = '1';

    toastTimeout = setTimeout(() => {
      toast.style.opacity = '0';
    }, 3000);
  });
});
</script>

</body>
</html>
